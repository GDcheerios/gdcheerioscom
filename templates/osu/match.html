<html>
    <head>
        {% block head %}
        <title>Home</title>
        <link rel="stylesheet" href="/static/style.css">
        <link rel="stylesheet" href="/static/osu-style.css">
        <style>
            @keyframes fadeSlideIn {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .player {
                opacity: 0;
                transform: translateY(-10px);
                animation: fadeSlideIn 0.4s ease-out forwards;
                transition: transform 0.35s ease, opacity 0.35s ease;
            }
        </style>
        {% endblock %}
    </head>
    <body>
        {% include 'navbar.html' %}
        {% block body %}
            <h1 style="text-align: center">{{ match.name }}</h1>

            <div class="match-layout">
                <!-- LEFT: players -->
                <div id="match-info" class="match-players-column">
                    <div id="loading-indicator">
                        <p>Loading match data...</p>
                    </div>
                </div>

                <!-- RIGHT: teams overview -->
                <div id="teams-overview" class="teams-overview">
                    <!-- filled by JS -->
                </div>
            </div>

            <script>
                const players = {{ players | tojson }};
                const currentOsuId = {{ current_osu_id|tojson }};  // may be null

                // compute match-relative score
                for (const player of players) {
                    if ({{ match.ended | tojson }}) {
                        player.score = player.ending_score - player.starting_score;
                    } else {
                        player.score = player.score - player.starting_score;
                    }
                }

                function canRefreshPlayer(player) {
                    // must be logged in AND same osu id
                    if (!currentOsuId) return false;
                    if (String(player.id) !== String(currentOsuId)) return false;

                    // need last_refresh from DB; if missing, allow refresh
                    if (!player.last_refresh) return true;

                    try {
                        const last = new Date(player.last_refresh); // UTC string from DB
                        if (isNaN(last.getTime())) return true; // can't parse? allow

                        const nowMs = Date.now();
                        const diffMs = nowMs - last.getTime();
                        return diffMs >= 60_000; // >= 1 minute
                    } catch (e) {
                        return true;
                    }
                }

                async function refreshPlayer(player, buttonEl) {
                    if (!canRefreshPlayer(player)) {
                        return;
                    }

                    buttonEl.disabled = true;
                    buttonEl.textContent = "Refreshing...";

                    try {
                        const response = await fetch(
                            `/api/osu/fetch-user/${encodeURIComponent(player.id)}`,
                            { method: "GET" }
                        );
                        if (!response.ok) {
                            throw new Error("Failed to refresh");
                        }

                        // Server updates osu_users + last_refresh; easiest is full reload
                        window.location.reload();
                    } catch (e) {
                        console.error(e);
                        buttonEl.disabled = false;
                        buttonEl.textContent = "Refresh";
                        alert("Failed to refresh player data.");
                    }
                }

                function createPlayerRow(player, index) {
                    const row = document.createElement('div');
                    row.className = 'player-row';

                    const rankText = document.createElement('div');
                    rankText.className = 'player-rank';
                    rankText.textContent = index + 1;

                    const card = document.createElement('div');
                    card.className = 'player';
                    card.style.animationDelay = `${index * 0.1}s`;

                    const bg = document.createElement('div');
                    bg.className = 'player-bg';
                    if (player.background) {
                        bg.style.backgroundImage = `url('${player.background}')`;
                    }
                    card.appendChild(bg);

                    const content = document.createElement('div');
                    content.className = 'player-content';

                    const main = document.createElement('div');
                    main.className = 'player-main';

                    const avatar = document.createElement('img');
                    avatar.className = 'player-avatar';
                    avatar.src = player.avatar;
                    avatar.alt = player.username || 'Player avatar';
                    main.appendChild(avatar);

                    const textBlock = document.createElement('div');
                    textBlock.className = 'player-text';

                    const nameEl = document.createElement('div');
                    nameEl.className = 'player-text-name';
                    nameEl.textContent = player.username;
                    textBlock.appendChild(nameEl);

                    const metaEl = document.createElement('div');
                    metaEl.className = 'player-text-meta';
                    const accValue = player.accuracy != null ? `${player.accuracy}%` : 'N/A';
                    const rankValue = player.rank != null ? `#${player.rank}` : 'Unranked';
                    metaEl.textContent = `ACC: ${accValue} â€¢ Rank: ${rankValue}`;
                    textBlock.appendChild(metaEl);

                    main.appendChild(textBlock);

                    const scoreWrapper = document.createElement('div');
                    scoreWrapper.className = 'player-score';

                    const scoreValueEl = document.createElement('div');
                    scoreValueEl.className = 'player-score-value';
                    const score = player.score != null ? player.score : 0;
                    scoreValueEl.textContent = Number(score).toLocaleString();
                    scoreWrapper.appendChild(scoreValueEl);

                    const scoreLabelEl = document.createElement('div');
                    scoreLabelEl.className = 'player-score-label';
                    scoreLabelEl.textContent = 'SCORE';
                    scoreWrapper.appendChild(scoreLabelEl);

                    // Add refresh button if allowed
                    if (canRefreshPlayer(player)) {
                        const refreshBtn = document.createElement('button');
                        refreshBtn.className = 'player-refresh-button';
                        refreshBtn.textContent = 'Refresh';
                        refreshBtn.onclick = () => refreshPlayer(player, refreshBtn);
                        scoreWrapper.appendChild(refreshBtn);
                    }

                    content.appendChild(main);
                    content.appendChild(scoreWrapper);
                    card.appendChild(content);

                    row.appendChild(rankText);
                    row.appendChild(card);

                    return row;
                }

                function buildTeams(playersArr) {
                    const teams = new Map();

                    for (const p of playersArr) {
                        const teamName = p.team || 'No Team';
                        if (!teams.has(teamName)) {
                            teams.set(teamName, { name: teamName, players: [], totalScore: 0 });
                        }
                        const team = teams.get(teamName);
                        team.players.push(p);
                        team.totalScore += p.score || 0;
                    }

                    return Array.from(teams.values()).sort(
                        (a, b) => b.totalScore - a.totalScore
                    );
                }

                function renderTeamsOverview(teams) {
                    const container = document.getElementById('teams-overview');
                    container.innerHTML = '';

                    const heading = document.createElement('h2');
                    heading.textContent = 'Teams Overview';
                    container.appendChild(heading);

                    teams.forEach(team => {
                        const card = document.createElement('div');
                        card.className = 'team-card';

                        const header = document.createElement('div');
                        header.className = 'team-card-header';

                        const nameEl = document.createElement('div');
                        nameEl.className = 'team-name';
                        nameEl.textContent = team.name;
                        header.appendChild(nameEl);

                        const scoreEl = document.createElement('div');
                        scoreEl.className = 'team-score';
                        scoreEl.textContent = Number(team.totalScore).toLocaleString();
                        header.appendChild(scoreEl);

                        card.appendChild(header);

                        const list = document.createElement('ul');
                        list.className = 'team-player-list';

                        team.players
                            .slice()
                            .sort((a, b) => b.score - a.score)
                            .forEach(p => {
                                const li = document.createElement('li');
                                li.textContent = `${p.username} (${Number(p.score || 0).toLocaleString()})`;
                                list.appendChild(li);
                            });

                        card.appendChild(list);
                        container.appendChild(card);
                    });
                }

                document.addEventListener('DOMContentLoaded', () => {
                    const matchInfo = document.getElementById('match-info');
                    const loading = document.getElementById('loading-indicator');
                    if (loading) loading.remove();

                    const sortedPlayers = [...players].sort((a, b) => b.score - a.score);

                    sortedPlayers.forEach((player, index) => {
                        const row = createPlayerRow(player, index);
                        matchInfo.appendChild(row);
                    });

                    const teams = buildTeams(sortedPlayers);
                    renderTeamsOverview(teams);
                });
            </script>
        {% endblock %}
    </body>
</html>