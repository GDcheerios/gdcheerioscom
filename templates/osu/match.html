<html>
    <head>
        {% block head %}
        <title>Home</title>
        <link rel="stylesheet" href="/static/style.css">
        <link rel="stylesheet" href="/static/osu-style.css">
        <style>
            @keyframes fadeSlideIn {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .player {
                opacity: 0;
                transform: translateY(-10px);
                animation: fadeSlideIn 0.4s ease-out forwards;
                transition: transform 0.35s ease, opacity 0.35s ease;
            }

            /* --- NEW: score bump + row move animations --- */
            @keyframes scoreBumpUp {
                0%   { transform: scale(1);   filter: none; }
                35%  { transform: scale(1.08); filter: drop-shadow(0 0 10px rgba(60, 255, 160, 0.55)); }
                100% { transform: scale(1);   filter: none; }
            }
            @keyframes scoreBumpDown {
                0%   { transform: scale(1);   filter: none; }
                35%  { transform: scale(0.98); filter: drop-shadow(0 0 10px rgba(255, 90, 90, 0.45)); }
                100% { transform: scale(1);   filter: none; }
            }
            .player-score-value.score-up {
                animation: scoreBumpUp 520ms ease-out;
            }
            .player-score-value.score-down {
                animation: scoreBumpDown 520ms ease-out;
            }

            /* Smooth “move up/down” (FLIP) */
            .player-row {
                will-change: transform;
            }
        </style>
        {% endblock %}
    </head>
    <body>
        {% include 'navbar.html' %}
        {% block body %}
            <h1 style="text-align: center">{{ match.name }}</h1>

            <div class="match-layout">
                <!-- LEFT: players -->
                <div id="match-info" class="match-players-column">
                    <div id="loading-indicator">
                        <p>Loading match data...</p>
                    </div>
                </div>

                <!-- RIGHT: teams overview -->
                <div id="teams-overview" class="teams-overview">
                    <!-- filled by JS -->
                </div>
            </div>
            <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
            <script>
                const players = {{ players | tojson }};
                const currentOsuId = {{ current_osu_id|tojson }};  // may be null
                const matchId = {{ match.id | tojson }};
                const matchEnded = {{ match.ended | tojson }};

                function applyMatchRelativeScores(playersArr) {
                    for (const player of playersArr) {
                        if (matchEnded) {
                            player.score = (player.ending_score - player.starting_score);
                        } else {
                            player.score = (player.score - player.starting_score);
                        }
                    }
                }

                applyMatchRelativeScores(players);

                // --- NEW: helpers for animations ---
                function easeOutCubic(t) {
                    return 1 - Math.pow(1 - t, 3);
                }

                function animateNumber(el, from, to, durationMs = 650) {
                    if (!el) return;
                    const start = performance.now();
                    const safeFrom = Number.isFinite(from) ? from : 0;
                    const safeTo = Number.isFinite(to) ? to : 0;

                    function tick(now) {
                        const t = Math.min(1, (now - start) / durationMs);
                        const v = Math.round(safeFrom + (safeTo - safeFrom) * easeOutCubic(t));
                        el.textContent = v.toLocaleString();

                        if (t < 1) requestAnimationFrame(tick);
                    }
                    requestAnimationFrame(tick);
                }

                function bumpScore(el, direction) {
                    if (!el) return;
                    // restart animation reliably
                    el.classList.remove("score-up", "score-down");
                    void el.offsetWidth;
                    el.classList.add(direction > 0 ? "score-up" : "score-down");
                }

                function captureRowPositions() {
                    const map = new Map();
                    document.querySelectorAll("#match-info .player-row[data-player-id]").forEach(row => {
                        map.set(row.dataset.playerId, row.getBoundingClientRect());
                    });
                    return map;
                }

                function animateRowReorder(prevRects) {
                    document.querySelectorAll("#match-info .player-row[data-player-id]").forEach(row => {
                        const id = row.dataset.playerId;
                        const prev = prevRects.get(id);
                        if (!prev) return;

                        const next = row.getBoundingClientRect();
                        const dy = prev.top - next.top;
                        if (Math.abs(dy) < 1) return;

                        row.style.transition = "none";
                        row.style.transform = `translateY(${dy}px)`;
                        // next frame: animate to 0
                        requestAnimationFrame(() => {
                            row.style.transition = "transform 420ms cubic-bezier(0.2, 0.9, 0.2, 1)";
                            row.style.transform = "translateY(0)";
                            // cleanup
                            setTimeout(() => {
                                row.style.transition = "";
                                row.style.transform = "";
                            }, 460);
                        });
                    });
                }

                async function refreshPlayer(player, buttonEl) {

                    buttonEl.disabled = true;
                    buttonEl.textContent = "Refreshing...";

                    try {
                        const response = await fetch(
                            `/api/osu/fetch-user/${encodeURIComponent(player.id)}`,
                            { method: "GET" }
                        );
                        if (!response.ok) {
                            throw new Error("Failed to refresh");
                        }
                        else {
                            setTimeout(() => {
                                buttonEl.disabled = false
                                buttonEl.textContent = "Refresh";
                            }, 5000);
                        }

                        // Server will emit socket update; also keep this as fallback
                        // window.location.reload();
                    } catch (e) {
                        console.error(e);
                        buttonEl.disabled = false;
                        buttonEl.textContent = "Refresh";
                        alert("Failed to refresh player data.");
                    }
                }

                function createPlayerRow(player, index) {
                    const row = document.createElement('div');
                    row.className = 'player-row';
                    // --- NEW: stable identity for FLIP ---
                    row.dataset.playerId = String(player.id);

                    const rankText = document.createElement('div');
                    rankText.className = 'player-rank';
                    rankText.textContent = index + 1;

                    const card = document.createElement('div');
                    card.className = 'player';
                    card.style.animationDelay = `${index * 0.1}s`;

                    const bg = document.createElement('div');
                    bg.className = 'player-bg';
                    if (player.background) {
                        bg.style.backgroundImage = `url('${player.background}')`;
                    }
                    card.appendChild(bg);

                    const content = document.createElement('div');
                    content.className = 'player-content';

                    const main = document.createElement('div');
                    main.className = 'player-main';

                    const avatar = document.createElement('img');
                    avatar.className = 'player-avatar';
                    avatar.src = player.avatar;
                    avatar.alt = player.username || 'Player avatar';
                    main.appendChild(avatar);

                    const textBlock = document.createElement('div');
                    textBlock.className = 'player-text';

                    const nameEl = document.createElement('div');
                    nameEl.className = 'player-text-name';
                    nameEl.textContent = player.username;
                    textBlock.appendChild(nameEl);

                    const metaEl = document.createElement('div');
                    metaEl.className = 'player-text-meta';
                    const accValue = player.accuracy != null ? `${player.accuracy}%` : 'N/A';
                    const rankValue = player.rank != null ? `#${player.rank}` : 'Unranked';
                    metaEl.textContent = `ACC: ${accValue} • Rank: ${rankValue}`;
                    textBlock.appendChild(metaEl);

                    main.appendChild(textBlock);

                    const scoreWrapper = document.createElement('div');
                    scoreWrapper.className = 'player-score';

                    const scoreValueEl = document.createElement('div');
                    scoreValueEl.className = 'player-score-value';
                    // --- NEW: stable identity for score element ---
                    scoreValueEl.dataset.scoreFor = String(player.id);

                    const score = player.score != null ? player.score : 0;
                    scoreValueEl.textContent = Number(score).toLocaleString();
                    scoreWrapper.appendChild(scoreValueEl);

                    const scoreLabelEl = document.createElement('div');
                    scoreLabelEl.className = 'player-score-label';
                    scoreLabelEl.textContent = 'SCORE';
                    scoreWrapper.appendChild(scoreLabelEl);

                    // Add refresh button if allowed
                    if (String(player.id) === String(currentOsuId)) {
                        const refreshBtn = document.createElement('button');
                        refreshBtn.className = 'player-refresh-button';
                        refreshBtn.textContent = 'Refresh';
                        refreshBtn.onclick = () => refreshPlayer(player, refreshBtn);
                        scoreWrapper.appendChild(refreshBtn);
                    }

                    content.appendChild(main);
                    content.appendChild(scoreWrapper);
                    card.appendChild(content);

                    row.appendChild(rankText);
                    row.appendChild(card);

                    return row;
                }

                function buildTeams(playersArr) {
                    const teams = new Map();

                    for (const p of playersArr) {
                        const teamName = p.team || 'No Team';
                        if (!teams.has(teamName)) {
                            teams.set(teamName, { name: teamName, players: [], totalScore: 0 });
                        }
                        const team = teams.get(teamName);
                        team.players.push(p);
                        team.totalScore += p.score || 0;
                    }

                    return Array.from(teams.values()).sort(
                        (a, b) => b.totalScore - a.totalScore
                    );
                }

                function renderTeamsOverview(teams) {
                    const container = document.getElementById('teams-overview');
                    container.innerHTML = '';

                    const heading = document.createElement('h2');
                    heading.textContent = 'Teams Overview';
                    container.appendChild(heading);

                    teams.forEach(team => {
                        const card = document.createElement('div');
                        card.className = 'team-card';

                        const header = document.createElement('div');
                        header.className = 'team-card-header';

                        const nameEl = document.createElement('div');
                        nameEl.className = 'team-name';
                        nameEl.textContent = team.name;
                        header.appendChild(nameEl);

                        const scoreEl = document.createElement('div');
                        scoreEl.className = 'team-score';
                        scoreEl.textContent = Number(team.totalScore).toLocaleString();
                        header.appendChild(scoreEl);

                        card.appendChild(header);

                        const list = document.createElement('ul');
                        list.className = 'team-player-list';

                        team.players
                            .slice()
                            .sort((a, b) => b.score - a.score)
                            .forEach(p => {
                                const li = document.createElement('li');
                                li.textContent = `${p.username} (${Number(p.score || 0).toLocaleString()})`;
                                list.appendChild(li);
                            });

                        card.appendChild(list);
                        container.appendChild(card);
                    });
                }

                function renderAll() {
                    const matchInfo = document.getElementById('match-info');
                    matchInfo.innerHTML = "";

                    const sortedPlayers = [...players].sort((a, b) => (b.score || 0) - (a.score || 0));
                    sortedPlayers.forEach((player, index) => {
                        const row = createPlayerRow(player, index);
                        matchInfo.appendChild(row);
                    });

                    const teams = buildTeams(sortedPlayers);
                    renderTeamsOverview(teams);
                }

                // --- NEW: render with FLIP reorder + animated score for changed player(s)
                function renderAllAnimated(scoreDiffsById) {
                    const prevRects = captureRowPositions();
                    renderAll();
                    animateRowReorder(prevRects);

                    if (!scoreDiffsById) return;
                    for (const [userId, diff] of scoreDiffsById.entries()) {
                        const el = document.querySelector(`.player-score-value[data-score-for="${CSS.escape(String(userId))}"]`);
                        if (!el) continue;

                        const p = players.find(x => String(x.id) === String(userId));
                        if (!p) continue;

                        // animate from (new - diff) to new
                        const to = Number(p.score || 0);
                        const from = to - Number(diff || 0);

                        if (diff !== 0) {
                            bumpScore(el, diff);
                            animateNumber(el, from, to, 650);
                        } else {
                            el.textContent = to.toLocaleString();
                        }
                    }
                }

                document.addEventListener('DOMContentLoaded', () => {
                    const loading = document.getElementById('loading-indicator');
                    if (loading) loading.remove();

                    renderAll();

                    // Socket.IO: join match room + listen for score updates
                    const socket = io({
                        transports: ["websocket", "polling"],
                    });

                    socket.on("connect", () => {
                        socket.emit("join_match", { match_id: String(matchId) });
                    });

                    socket.on("match_user_score_updated", (payload) => {
                        console.log("Socket update:", payload);
                        if (!payload) return;
                        if (String(payload.match_id) !== String(matchId)) return;

                        const userId = String(payload.player.id);
                        const newScore = Number(payload.player.score);

                        const p = players.find(x => String(x.id) === userId);
                        if (!p) return;

                        console.log(p.score)
                        console.log(`Player ${userId} score changed to ${newScore}`);

                        const oldRel = Number(p.score || 0);
                        p.score = newScore - p.starting_score;
                        const newRel = Number(p.score || 0);

                        console.log(`Player ${userId} score changed from ${oldRel} to ${newRel}`);

                        const diffs = new Map();
                        diffs.set(userId, newRel - oldRel);

                        renderAllAnimated(diffs);
                    });
                });
            </script>
        {% endblock %}
    </body>
</html>