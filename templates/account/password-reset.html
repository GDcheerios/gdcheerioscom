<html>
  <head>
    {% block head %}
    <title>Reset password</title>
    <link rel="stylesheet" href="/static/style.css">
    {% endblock %}
  </head>
  <body>
    {% include 'navbar.html' %}
    {% block body %}
    <script>
      function sendEmail() {
        var email = document.getElementById("email").value;
        fetch('/api/account/send-reset-email', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({email: email})
        }).then(function(response) {
          return response.json();
        }).then(function(data) {
          if (data.success) {
            alert('Password reset link sent to ' + email);
          } else {
            alert('Failed to send password reset link. Please try again later.');
          }
        });
      }

      async function resetPassword() {
        console.log('resetting password');
        var password = document.getElementById("password").value;
        var code = new URLSearchParams(window.location.search).get('code');
        let response;
        try {
          response = await fetch('/api/account/reset-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password: password, code: code })
          });
        } catch (err) {
          alert('Network error. Please check your connection and try again.');
          return;
        }

        console.log(response);
        
        if (response.status === 200) {
          window.location.href = '/account/';
        }
        else {
          alert('Invalid password reset link.');
        }
      }
    </script>
    <div class="container">
      <h1>Reset Password</h1>
      {% if code %}
      <form onsubmit="event.preventDefault(); resetPassword();">
            Password: <input type="password" id="password" name="password" required>
            <button type="submit">Reset Password</button>
        </form>
      {% else %}
        <p>Enter your email address, and we'll send you a link to reset your password.</p>
        <form onsubmit="event.preventDefault(); sendEmail();">
          <div class="form-group">
            <label for="email">Email address:</label>
            <input type="email" id="email" name="email" required>
          </div>

          <button type="submit">Send Reset Link</button>
        </form>
      {% endif %}



      <p><a href="/account/login">Back to Login</a></p>
    </div>
    {% endblock %}
  </body>
</html>