<html>
<head>
    {% block head %}
    <title>{{ account.username }} profile</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/accounts-style.css">
    <meta name="description" content="{{username}}'s profile">
    {% endblock %}
</head>
<body>
{% include 'navbar.html' %}
{% block body %}
<div class="block" style="margin-top: 3%;">
    <div style="display: flex; flex-direction: row; justify-content: space-between; margin-bottom: 10px;">
        <div style="display: flex; flex-direction: row; margin-right: 10px;">
            <img style="display: block;" src="{{ account.pfp }}">
            <div>
                <h1 class="username">{{account.username}}</h1>
                <div id="tags"></div>
            </div>
        </div>
        <div style="display: flex; flex-direction: row;">
            <h2 class="about">{{ account.about|safe }}</h2>
        </div>
    </div>
    <script>
        const tags = {{ account.tags | safe }};
        const tagsContainer = document.getElementById('tags');
        const typePriority = {
            "gd": 1,
            "dev": 2,
            "unique": 3,
            "rare": 4,
            "event": 5
        };
        const userStatusTag = {
            "account": {{ account.id }},
            "id": 1,
            "title": "{{ account.status }}",
            "type": "{{ account.status }}"
        }


        const sortedTags = tags.sort((a, b) => {
            const priorityA = typePriority[a.type] || 100;
            const priorityB = typePriority[b.type] || 100;

            return priorityA - priorityB;
        });


        function addTag(tag) {
            const tagElement = document.createElement('span');
            tagElement.classList.add('tag');
            if (tag.type) {
                tagElement.classList.add(`tag-${tag.type}`);
            }
            tagElement.textContent = tag.title;
            tagsContainer.appendChild(tagElement);
        }

        if (userStatusTag.type === "restricted") addTag(userStatusTag);
        sortedTags.forEach((tag) => {
            addTag(tag);
        });
    </script>
</div>
{% if account.gq_data.ranking %}
    <div id="gq-data" class="block gq-card">
        <h1>Gentrys Quest</h1>

        <!-- New grouped layout -->
        {% set score_i = (account.gq_data['metadata']['score'] | int) %}
        {% set required_i = (account.gq_data['metadata']['required'] | int) %}
        {% set next_i = (required_i - score_i) if (required_i - score_i) > 0 else 0 %}
        {% set pct = ((score_i / (required_i if required_i != 0 else 1)) * 100) | round(0, 'floor') | int %}

        <div style="display:grid; grid-template-columns: 280px 1fr; gap:14px;">
            <!-- Left column: Rank card -->
            <div style="border:1px solid #2b2b2b; border-radius:12px; background:#111; padding:14px;">
                <div
                    class="gq-rank-badge"
                    style="
                        --rank-color: {{ rater.rating_colors[account.gq_data['ranking']['rank']] }};
                        background:
                          linear-gradient(
                            135deg,
                            color-mix(in srgb, var(--rank-color) 100%, black 0%) 0%,
                            color-mix(in srgb, var(--rank-color) 85%, black 15%) 45%,
                            color-mix(in srgb, var(--rank-color) 70%, black 30%) 100%
                          );
                        border-radius:10px;
                        color:#fff;
                    ">
                    <div class="gq-rank-title">{{ account.gq_data['ranking']['rank'] }}</div>
                    <div class="gq-tier">Tier {{ account.gq_data['ranking']['tier'] }}</div>
                </div>
                <div class="gq-metrics" style="margin-top:12px; display:grid; grid-template-columns: 1fr; gap:8px;">
                    <div class="gq-metric" style="display:flex; justify-content:space-between;">
                        <div class="gq-metric-label">Placement</div>
                        <div class="gq-metric-value">#{{ "{:,}".format(account.gq_data["ranking"]["placement"]) }}</div>
                    </div>
                    <div class="gq-metric" style="display:flex; justify-content:space-between;">
                        <div class="gq-metric-label">Weighted</div>
                        <div class="gq-metric-value">{{ "{:,}".format(account.gq_data["ranking"]["weighted"]) }}</div>
                    </div>
                    <div class="gq-metric" style="display:flex; justify-content:space-between;">
                        <div class="gq-metric-label">Unweighted</div>
                        <div class="gq-metric-value">{{ "{:,}".format(account.gq_data["ranking"]["unweighted"]) }}</div>
                    </div>
                </div>
            </div>

            <!-- Right column: Experience card -->
            <div style="border:1px solid #2b2b2b; border-radius:12px; background:#111; padding:14px; display:grid; grid-template-columns: 140px 1fr 160px; gap:12px; align-items:center;">
                <!-- Level tile -->
                <div style="display:flex; flex-direction:column; align-items:center; gap:8px;">
                    <div style="font-size:12px; opacity:0.75;">Level</div>
                    <div style="
                        width:64px; height:64px; border-radius:14px;
                        display:flex; align-items:center; justify-content:center;
                        background: linear-gradient(135deg,#2a2a2a,#1a1a1a);
                        border:1px solid #333; font-weight:900; font-size:22px;">
                        {{ account.gq_data['metadata']['level'] | int }}
                    </div>
                    <div style="font-size:12px; opacity:0.7;">Total XP</div>
                    <div style="font-weight:700;">{{ "{:,}".format(score_i) }}</div>
                </div>

                <!-- Progress -->
                <div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div style="position:relative; flex:1; height:18px; background:#0f0f0f; border:1px solid #272727; border-radius:999px; overflow:hidden;">
                            <div style="
                                position:absolute; height:100%; width: {{ pct }}%;
                                background: linear-gradient(90deg,#00d2ff,#3a7bd5);
                                box-shadow: 0 0 12px rgba(0,210,255,0.35);">
                            </div>
                            <div style="position:absolute; inset:0; background:
                                repeating-linear-gradient(120deg, rgba(255,255,255,0.06) 0, rgba(255,255,255,0.06) 8px, transparent 8px, transparent 16px);
                                mix-blend-mode: overlay;"></div>
                        </div>
                        <div style="min-width:46px; text-align:right; font-variant-numeric: tabular-nums; font-weight:700; font-size:12px; opacity:0.9;">
                            {{ pct }}%
                        </div>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-top:6px; font-size:12px; opacity:0.75;">
                        <span>0</span>
                        <span>{{ "{:,}".format(required_i) }}</span>
                    </div>
                </div>

                <!-- Next level -->
                <div style="text-align:right;">
                    <div style="font-size:12px; opacity:0.8;">Next level in</div>
                    <div style="font-weight:900; font-size:22px;">{{ "{:,}".format(next_i) }} XP</div>
                </div>
            </div>
        </div>
        <!-- End grouped layout -->
    <div id="gq-scores">
        <div id="leaderboard-container">
            <h1 style="text-align: center; font-size: 24px; margin-bottom: 20px;">Scores</h1>
            <select id="leaderboard-toggle" style="margin: 10px auto; display: block;" onchange="renderLeaderboard()"></select>
            <div id="leaderboard-list" class="leaderboard-list"></div>
        </div>
    </div>
    <script>
        const leaderboardData = {{ account.gq_data["scores"] | safe }};

        function initializeLeaderboard() {
            const dropdown = document.getElementById('leaderboard-toggle');
            for (const leaderboardName of Object.keys(leaderboardData)) {
                const option = document.createElement('option');
                option.value = leaderboardName;
                option.textContent = leaderboardName;
                dropdown.appendChild(option);
            }
            renderLeaderboard();
        }

        function renderLeaderboard() {
            const selectedLeaderboard = document.getElementById('leaderboard-toggle').value;
            const scores = leaderboardData[selectedLeaderboard];
            const leaderboardList = document.getElementById('leaderboard-list');
            leaderboardList.innerHTML = '';
            if (scores) {
                scores.sort((a, b) => b.score - a.score).forEach((entry, index) => {
                    const item = document.createElement('div');
                    item.className = 'leaderboard-entry';
                    item.innerHTML = `
                    <div class="rank">${index + 1}</div>
                    <div class="score">${entry.score.toLocaleString()}</div>
                `;
                    leaderboardList.appendChild(item);
                });
            }
        }

        document.addEventListener('DOMContentLoaded', initializeLeaderboard);
    </script>
    <script>
        const items = {{ account.gq_data["items"] | tojson | safe }} || [];

        // Helpers
        const ucfirst = s => (s ? s.charAt(0).toUpperCase() + s.slice(1) : '');

        function safeParse(md) {
            if (!md) return null;
            if (typeof md === 'object') return md;
            try { return JSON.parse(md); } catch { return null; }
        }

        function fmt(num) {
            return typeof num === 'number' ? num.toLocaleString() : num ?? '-';
        }

        function chip(label) {
            const el = document.createElement('span');
            el.className = 'gq-chip';
            el.textContent = label;
            return el;
        }

        // Per-type renderers
        function renderCharacter(md, card) {
            // Header line: Name + star rating
            const name = md?.name || 'Character';
            const sr = md?.['star rating'];
            const exp = md?.experience;
            const header = document.createElement('div');
            header.className = 'gq-item-line';
            header.innerHTML = `<strong>${name}</strong> ${sr ? ` • ${'★'.repeat(Math.min(5, sr))}` : ''}`;
            card.appendChild(header);

            // Level + XP
            const meta = document.createElement('div');
            meta.className = 'gq-item-meta';
            if (exp?.level != null) meta.appendChild(chip(`Lv ${fmt(exp.level)}`));
            if (exp?.xp != null) meta.appendChild(chip(`${fmt(exp.xp)} XP`));
            card.appendChild(meta);

            // Core stats (attack/health/defense/crit)
            const stats = md?.stats;
            const statList = document.createElement('div');
            statList.className = 'gq-stat-grid';
            const entries = [
                ['Attack', stats?.attack],
                ['Health', stats?.health],
                ['Defense', stats?.defense],
                ['Crit Rate', stats?.critRate],
                ['Crit Dmg', stats?.critDamage]
            ];
            entries.forEach(([k,v]) => {
                if (v != null) {
                    const s = document.createElement('div');
                    s.className = 'gq-stat';
                    s.innerHTML = `<span>${k}</span><b>${fmt(v)}</b>`;
                    statList.appendChild(s);
                }
            });
            if (statList.children.length) card.appendChild(statList);

            // Weapon summary
            const weapon = md?.equips?.weapon;
            if (weapon) {
                const w = document.createElement('div');
                w.className = 'gq-subsection';
                const wExp = weapon.experience;
                const wBuff = weapon.stats?.buff?.buff;
                const wAttack = weapon.stats?.attack;
                const buffText = wBuff ? `Buff: [${wBuff.join(', ')}]` : (wAttack != null ? `Attack +${fmt(wAttack)}` : '');
                w.innerHTML = `
        <div class="gq-subtitle">Weapon</div>
        <div class="gq-item-line"><strong>${weapon.name || 'Weapon'}</strong>${weapon['star rating'] ? ` • ${'★'.repeat(Math.min(5, weapon['star rating']))}` : ''}</div>
        <div class="gq-item-meta"></div>
        <div class="gq-muted">${buffText}</div>
      `;
                const meta = w.querySelector('.gq-item-meta');
                if (wExp?.level != null) meta.appendChild(chip(`Lv ${fmt(wExp.level)}`));
                if (wExp?.xp != null) meta.appendChild(chip(`${fmt(wExp.xp)} XP`));
                card.appendChild(w);
            }

            // Artifacts grid (name, star, main attribute)
            const arts = md?.equips?.artifacts || [];
            if (Array.isArray(arts) && arts.length) {
                const sec = document.createElement('div');
                sec.className = 'gq-subsection';
                sec.innerHTML = `<div class="gq-subtitle">Artifacts (${arts.length})</div>`;
                const grid = document.createElement('div');
                grid.className = 'gq-art-grid';
                arts.forEach(a => {
                    if (!a) return;
                    const main = a.stats?.['main attribute'];
                    const mainBuff = main?.buff ? `[${main.buff.join(', ')}]` : '';
                    const el = document.createElement('div');
                    el.className = 'gq-art';
                    el.innerHTML = `
          <div class="gq-item-line"><strong>${a.name || 'Artifact'}</strong>${a['star rating'] ? ` • ${'★'.repeat(Math.min(5, a['star rating']))}` : ''}</div>
          <div class="gq-muted">${mainBuff}</div>
        `;
                    const m = document.createElement('div');
                    m.className = 'gq-item-meta';
                    if (a.experience?.level != null) m.appendChild(chip(`Lv ${fmt(a.experience.level)}`));
                    grid.appendChild(el);
                    el.appendChild(m);
                });
                sec.appendChild(grid);
                card.appendChild(sec);
            }
        }

        function renderWeapon(md, card) {
            const name = md?.name || 'Weapon';
            const sr = md?.['star rating'];
            const header = document.createElement('div');
            header.className = 'gq-item-line';
            header.innerHTML = `<strong>${name}</strong> ${sr ? ` • ${'★'.repeat(Math.min(5, sr))}` : ''}`;
            card.appendChild(header);

            const meta = document.createElement('div');
            meta.className = 'gq-item-meta';
            if (md?.experience?.level != null) meta.appendChild(chip(`Lv ${fmt(md.experience.level)}`));
            if (md?.experience?.xp != null) meta.appendChild(chip(`${fmt(md.experience.xp)} XP`));
            if (md?.['weapon type']) meta.appendChild(chip(md['weapon type']));
            card.appendChild(meta);

            const wBuff = md?.stats?.buff?.buff;
            const wAttack = md?.stats?.attack;
            const details = document.createElement('div');
            details.className = 'gq-muted';
            details.textContent = wBuff ? `Buff: [${wBuff.join(', ')}]` : (wAttack != null ? `Attack +${fmt(wAttack)}` : '');
            card.appendChild(details);

            if (md?.verbs?.normal || md?.verbs?.critical) {
                const verbs = document.createElement('div');
                verbs.className = 'gq-muted';
                verbs.textContent = `Verbs: ${[md.verbs.normal, md.verbs.critical].filter(Boolean).join(' / ')}`;
                card.appendChild(verbs);
            }
        }

        function renderArtifact(md, card) {
            const name = md?.name || 'Artifact';
            const sr = md?.['star rating'];
            const header = document.createElement('div');
            header.className = 'gq-item-line';
            header.innerHTML = `<strong>${name}</strong> ${sr ? ` • ${'★'.repeat(Math.min(5, sr))}` : ''}`;
            card.appendChild(header);

            const meta = document.createElement('div');
            meta.className = 'gq-item-meta';
            if (md?.experience?.level != null) meta.appendChild(chip(`Lv ${fmt(md.experience.level)}`));
            if (md?.family) meta.appendChild(chip(md.family));
            card.appendChild(meta);

            const main = md?.stats?.['main attribute'];
            const attrs = md?.stats?.attributes || [];
            const mainBuff = main?.buff ? `[${main.buff.join(', ')}]` : null;

            if (mainBuff) {
                const line = document.createElement('div');
                line.className = 'gq-muted';
                line.textContent = `Main: ${mainBuff}`;
                card.appendChild(line);
            }

            if (Array.isArray(attrs) && attrs.length) {
                const list = document.createElement('div');
                list.className = 'gq-attrs';
                attrs.slice(0, 5).forEach(b => {
                    const txt = b?.buff ? `[${b.buff.join(', ')}]` : '';
                    if (txt) list.appendChild(chip(txt));
                });
                card.appendChild(list);
            }
        }

        function createItemCard(item) {
            const card = document.createElement('div');
            card.className = `gq-item-card gq-item-${item.type}`;

            // Top line: type + id + rating
            const top = document.createElement('div');
            top.className = 'gq-item-top';
            top.innerHTML = `
      <div class="gq-item-type">${ucfirst(item.type)}</div>
      <div class="gq-item-id">#${item.id}</div>
    `;
            const rating = document.createElement('div');
            rating.className = 'gq-item-rating';
            rating.textContent = `Rating: ${fmt(Number(item.rating ?? 0))}`;
            top.appendChild(rating);
            card.appendChild(top);

            const md = safeParse(item.metadata);

            // Dispatch
            if (item.type === 'character') renderCharacter(md, card);
            else if (item.type === 'weapon') renderWeapon(md, card);
            else if (item.type === 'artifact') renderArtifact(md, card);
            else {
                const fallback = document.createElement('div');
                fallback.className = 'gq-muted';
                fallback.textContent = 'Unknown item type';
                card.appendChild(fallback);
            }

            // Description if present
            if (md?.description) {
                const desc = document.createElement('div');
                desc.className = 'gq-desc';
                desc.textContent = md.description;
                card.appendChild(desc);
            }

            return card;
        }

        function renderItems(limit = 12) {
            const grid = document.getElementById('gq-items-grid');
            grid.innerHTML = '';
            const subset = items.slice(0, limit);
            subset.forEach(it => grid.appendChild(createItemCard(it)));

            // Show-all button
            let existing = document.getElementById('gq-items-more');
            if (existing) existing.remove();
            if (items.length > limit) {
                const more = document.createElement('button');
                more.id = 'gq-items-more';
                more.className = 'gq-items-more';
                more.textContent = `Show all (${items.length})`;
                more.onclick = () => renderItems(items.length);
                grid.parentElement.appendChild(more);
            }
        }

        document.addEventListener('DOMContentLoaded', () => renderItems());
    </script>
</div>
{% endif %}
{% if account.has_osu %}
<div id="osu-data" class="block">
    <h1>OSU!</h1>
    <div style="display: flex; flex-direction: row; justify-content: space-evenly; margin-bottom: 10px; margin-top: 10px;">
        <div style="display: flex; flex-direction: row;">
            <img src="https://a.ppy.sh/{{ account.osu_id }}">
            <div style="display: flex; flex-direction: column; margin-left: 10px;">
                <h2 style="margin-bottom: 0;"><a href="https://osu.ppy.sh/users/{{ account.osu_id }}" target="_blank">{{
                    account.osu_data.username }}</a></h2>
                <h2>#{{ "{:,}".format(account.osu_data.rank) }}</h2>
            </div>
        </div>
        <div style="display: flex; flex-direction: column; margin-left: 10px;">
            <h2 style="margin-bottom: 0;">{{ "{:,}".format(account.osu_data.score) }} score</h2>
            <h2 style="margin-bottom: 0;">{{ "{:,}".format(account.osu_data.playcount) }} plays</h2>
            <h2 style="margin-bottom: 0;">{{ "{:,}".format(account.osu_data.accuracy) }} accuracy</h2>
            <h2 style="margin-bottom: 0;">{{ "{:,}".format(account.osu_data.performance) }} pp</h2>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
</body>
</html>
